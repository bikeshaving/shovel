# Shovel Feedback & Bugs

## ✅ FIXED: Build-time and runtime errors now surface properly

As of `@b9g/shovel@0.2.0-beta.4` and `@b9g/platform@0.1.7`:

**Build-time errors** (missing exports/imports) are caught by esbuild:
```
✘ [ERROR] No matching export in "node_modules/@b9g/assets/src/index.js" for import "createAssetsMiddleware"
21:43:31.124 ERR cli Initial build failed, watching for changes to retry
```

**Runtime errors** (TypeErrors, ReferenceErrors during initialization) are now properly propagated:
```
21:57:35.706 ERR cli Failed to start development server:
Error: Worker failed to load ServiceWorker: notAFunction is not a function
```

Both fixes ensure developers get immediate feedback when errors occur.

---

## ✅ FIXED: Assets middleware blocks all routes

**Package**: `@b9g/assets@0.1.9` → Fixed in `@b9g/assets@0.1.12`

**Description**: The `assets()` middleware from `@b9g/assets/middleware` blocks all routes instead of falling through when the request doesn't match an asset.

**Reproduction**:
```typescript
import {Router} from "@b9g/router";
import {assets} from "@b9g/assets/middleware";

const router = new Router();
router.use(assets()); // This blocks all non-asset routes

router.route("/").get(() => new Response("Hello")); // Never reached

self.addEventListener("fetch", (event) => {
  event.respondWith(router.handler(event.request));
});
```

**Expected**: Requests to `/` should return "Hello". The middleware should return `undefined` for non-asset paths, allowing routes to handle them.

**Actual**: All routes return 404 "Not Found".

**Root cause** (in `middleware.ts`):
1. `loadManifest()` may throw errors (e.g., manifest file not found)
2. The catch block returns `new Response("Not Found", {status: 404})` instead of `undefined`
3. This blocks all routes from being handled

**Suggested fix**:
- Only intercept requests that start with the asset base path (e.g., `/static/`)
- Return `undefined` for all other paths to allow fallthrough to routes

### Additional issue: Extremely opaque error behavior

When this bug occurs, the developer experience is very poor:

**What the user sees:**
- Browser shows `about:blank` or blank page
- No console errors
- Server logs show nothing wrong:
  ```
  INF cli Server running
  INF cli Serving
  ```

**Root cause of opacity:**

1. **Wrong content-type**: The middleware returns `application/octet-stream` instead of `text/plain`:
   ```
   HTTP/1.1 404 Not Found
   content-type: application/octet-stream  <-- Browser doesn't know how to display this
   Content-Length: 9
   Body: "Not Found"
   ```

2. **No logging**: Middleware fails silently - no indication in server logs that:
   - Manifest failed to load
   - Routes are being blocked
   - 404s are being returned

3. **No request logging**: Can't see what requests are hitting the server

**Suggested improvements:**
- Use `text/plain` or `text/html` content-type for error responses
- Log warnings in dev mode when middleware blocks requests
- Add request logging option for debugging

---

## ✅ FIXED: Assets middleware can't find assets in dev mode

**Package**: `@b9g/assets@0.1.11` → Fixed in `@b9g/assets@0.1.12`

**Description**: The assets middleware reads from `self.buckets.open("static")` but assets generated by Shovel are written to the filesystem (`dist/static/static/`), not to the bucket.

**What happens:**
1. Shovel generates assets at `dist/static/static/client-xxx.css`
2. Shovel generates manifest at `dist/server/asset-manifest.json`
3. Middleware tries to read from bucket: `self.buckets.open("static").getFileHandle("manifest.json")`
4. Bucket doesn't have the files → middleware returns `undefined` → falls through to router → 404

**Result**: Routes work, but static assets at `/static/*` return 404.

**Suggested fix**: Dev server should populate the "static" bucket with bundled assets, or middleware needs a dev mode that reads from filesystem.

---

## ✅ FIXED: Router doesn't handle HEAD requests for GET routes

**Package**: `@b9g/router@0.1.6` → Fixed in `@b9g/router@0.1.7`

**Description**: Per HTTP spec (RFC 7231), servers SHOULD support HEAD for any resource that supports GET. Most frameworks (Express, Fastify, Hono) automatically handle HEAD requests for GET routes.

**Reproduction**:
```typescript
router.route("/").get(() => new Response("Hello"));

// GET works
fetch("http://localhost:1337/", { method: "GET" }); // 200 OK

// HEAD fails
fetch("http://localhost:1337/", { method: "HEAD" }); // 404 Not Found
```

**Expected**: HEAD should return same headers as GET, without body.

**Actual**: HEAD returns 404 because `.get()` only registers GET handler.

**Impact**: Breaks `curl -I`, health checks, caching proxies, CDNs, etc.

**Suggested fix**: `.get()` should automatically register HEAD handler that returns GET response with empty body.

---

## Bug: CSS `@import` statements not bundled

**Package**: `@b9g/shovel@0.2.0-beta.4`

**Description**: When using a CSS file as an asset entrypoint with `import ... with {assetBase: "/static/"}`, CSS `@import` statements are not resolved/bundled. They're left as-is in the output, causing browser 404s at runtime.

**Reproduction**:
```css
/* src/styles/client.css */
@import "normalize.css/normalize.css";
@import "./prism-theme.css";

:root { --bg-color: #0a0e1f; }
```

```typescript
// src/app.ts
import clientCSS from "./styles/client.css" with {assetBase: "/static/"};
```

**Expected**: The bundled CSS should inline the `@import` contents.

**Actual**: Output CSS still contains `@import` statements, browser tries to fetch `/normalize.css/normalize.css` and `/prism-theme.css` → 404.

**Root cause**: esbuild needs `bundle: true` to resolve CSS imports, but Shovel appears to only copy/hash CSS files without bundling.

**Suggested fix**: Pass `bundle: true` to esbuild for CSS entrypoints.

---

## ✅ PARTIAL FIX: Trailing slash routes return 404 with no Content-Type

**Package**: `@b9g/router@0.1.7` → Fixed Content-Type in `@b9g/router@0.1.8`

**Original issue**: Routes defined without trailing slash don't match requests with trailing slash. The 404 response had no Content-Type header, causing browsers to interpret it as `application/octet-stream`.

**What's fixed**:
- Router now uses `@b9g/http-errors` for 404 responses, which includes proper `Content-Type: text/html` headers
- 404 pages now render a developer-friendly HTML error page instead of plain "Not Found"

**What's still TODO**:
- Trailing slash normalization (redirect `/path/` to `/path` or vice versa)
- Option to match both `/path` and `/path/`

**Reproduction of remaining issue**:
```typescript
router.route("/playground").get(() => new Response("Hello"));

// Works
fetch("http://localhost:1337/playground"); // 200 OK

// Still 404, but now with proper Content-Type and HTML body
fetch("http://localhost:1337/playground/"); // 404, Content-Type: text/html
```

---

## Bug: Path duplication in beta.5 causes startup failure

**Package**: `@b9g/shovel@0.2.0-beta.5`

**Description**: Dev server fails to start due to path resolution doubling the working directory name.

**Error**:
```
Error: Worker failed to load ServiceWorker: ResolveMessage: Cannot find module
'/Users/briankim/Projects/crank/website/website/dist/server/app-GU5EM5DN.js?v=1764550349873'
```

Note the doubled `website/website` path. Working directory is `/Users/briankim/Projects/crank/website`.

**Expected**: Should resolve to `/Users/briankim/Projects/crank/website/dist/server/app-xxx.js`

**Actual**: Resolves to `/Users/briankim/Projects/crank/website/website/dist/server/app-xxx.js`

**Impact**: Complete dev server failure - cannot start at all.

**Regression**: Worked in `@b9g/shovel@0.2.0-beta.4`.
